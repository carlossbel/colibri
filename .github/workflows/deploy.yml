name: Blue-Green CI/CD

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install backend dependencies
      working-directory: ./colibri-backend
      run: npm install
    
    - name: Run integration tests
      working-directory: ./colibri-backend
      run: npm test
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        NODE_ENV: test
  
  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to GHCR
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build and push
      uses: docker/build-push-action@v5
      with:
        context: ./colibri-frontend
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
        cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

  blue-green-deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy with Blue-Green
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd ~/colibri
          
          export GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}"
          export GITHUB_USER="${{ github.actor }}"
          
          echo "[INFO] Detectando ambiente activo..."
          ACTIVE_PORT=$(grep -oP 'server localhost:\K\d+' /etc/nginx/sites-available/colibri-blue-green | head -1)
          
          if [ "$ACTIVE_PORT" == "8001" ]; then
            TARGET="green"
            TARGET_PORT="8002"
            TARGET_COMPOSE="docker-compose.green.yml"
            echo "[INFO] Blue esta activo, desplegando en Green"
          else
            TARGET="blue"
            TARGET_PORT="8001"
            TARGET_COMPOSE="docker-compose.blue.yml"
            echo "[INFO] Green esta activo, desplegando en Blue"
          fi
          
          echo "[DEPLOY] Desplegando en $TARGET (puerto $TARGET_PORT)"
          
          # Login a GHCR
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # Pull nueva imagen
          docker-compose -f $TARGET_COMPOSE pull
          
          # Deploy en ambiente inactivo
          docker-compose -f $TARGET_COMPOSE down
          docker-compose -f $TARGET_COMPOSE up -d
          
          # Esperar que este listo
          echo "[WAIT] Esperando que $TARGET este listo..."
          sleep 10
          
          # Health check
          echo "[HEALTH] Verificando salud de $TARGET..."
          for i in {1..15}; do
            if curl -f http://localhost:$TARGET_PORT/ &> /dev/null; then
              echo "[SUCCESS] $TARGET esta funcionando"
              break
            fi
            if [ $i -eq 15 ]; then
              echo "[ERROR] $TARGET no respondio"
              exit 1
            fi
            echo "[HEALTH] Intento $i/15..."
            sleep 2
          done
          
          # Switch automatico
          echo "[SWITCH] Cambiando trafico a $TARGET..."
          ~/colibri/scripts/switch-deployment.sh
          
          # Verificar
          echo "[SUCCESS] Deployment completado"
          echo "[STATUS] Estado actual:"
          curl http://35.208.59.77/deployment-status
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"